# Docker network –∏ –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–µ compose

## –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã

* –î–∞ ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è **–º–æ–≥—É—Ç** –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∏–∑ —Å–≤–æ–µ–≥–æ `docker-compose`, –µ—Å–ª–∏ —Å–µ—Ç–µ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ (docker network) —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
* **–ï—Å–ª–∏ —Å–µ—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç** –∏ –≤ `docker-compose.yml` –æ–Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∞ –∫–∞–∫ `external: true`, —Ç–æ `docker compose up` —É–ø–∞–¥—ë—Ç —Å –æ—à–∏–±–∫–æ–π.
* **–ï—Å–ª–∏ —Å–µ—Ç—å –µ—Å—Ç—å**, –Ω–æ `vpn`-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω ‚Äî —Å–µ—Ç—å –ø—Ä–æ—Å—Ç–æ –±—É–¥–µ—Ç ¬´–ø—É—Å—Ç–æ–π¬ª (–æ–±—ã—á–Ω—ã–π bridge). App-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å–º–æ–≥—É—Ç –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è –º–µ–∂–¥—É —Å–æ–±–æ–π, –Ω–æ –∏–º—è `vpn` –≤ Docker-DNS **–Ω–µ –±—É–¥–µ—Ç —Ä–µ–∑–æ–ª–≤–∏—Ç—å—Å—è** –≤ IP (—Ç.–µ. `socks5h://vpn:1080` ‚Äî –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç).
* –ù–∞–ª–∏—á–∏–µ —Å–µ—Ç–∏ **–Ω–µ —Å–æ–∑–¥–∞—ë—Ç VPN-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å tun0** –∏ –Ω–µ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –≤ VPN –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî tun0 –∂–∏–≤—ë—Ç –≤–Ω—É—Ç—Ä–∏ vpn-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ü–æ–∫–∞ vpn –Ω–µ –∑–∞–ø—É—â–µ–Ω, ¬´vpn-—Å–µ—Ç—å¬ª ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–µ—Ç—å Docker –∏ —Ç—Ä–∞—Ñ–∏–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —É—Ö–æ–¥–∏—Ç –Ω–∞—Ä—É–∂—É –ø–æ –æ–±—ã—á–Ω–æ–º—É NAT —Ö–æ—Å—Ç–∞.

---

## –î–µ—Ç–∞–ª–∏: –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–æ—á–µ–º—É

### 1. Docker network vs VPN –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

* Docker network ‚Äî —ç—Ç–æ –ª–æ–≥–∏—á–µ—Å–∫–∏–π –º–æ—Å—Ç (bridge) —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π Docker daemon. –û–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –µ—Å—Ç—å –ª–∏ –≤–Ω—É—Ç—Ä–∏ –Ω–µ—ë –∫–∞–∫–∏–µ-—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã.
* VPN (tun0) ‚Äî —ç—Ç–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –ø–æ–¥–Ω—è—Ç—ã–π *–≤–Ω—É—Ç—Ä–∏* vpn-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –û–Ω –Ω–µ ¬´–≤–ø–∏–ª–∏–≤–∞–µ—Ç—Å—è¬ª –≤ Docker network. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∫—Å–∏ –≤–Ω—É—Ç—Ä–∏ vpn-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (dante/tinyproxy) —Å–ª—É—à–∞–µ—Ç –Ω–∞ IP –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ Docker network –∏ –¥–µ–ª–∞–µ—Ç egress —á–µ—Ä–µ–∑ tun0.

### 2. –ö–æ–≥–¥–∞ app –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Å–µ—Ç—å –µ—Å—Ç—å, –Ω–æ vpn –Ω–µ –∑–∞–ø—É—â–µ–Ω

* App –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Å–µ—Ç–∏ `vpn-net` ‚Üí —ç—Ç–æ —É–¥–∞—á–Ω–æ.
* `docker` DNS –≤—ã–¥–∞—ë—Ç –∏–º–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è **—Ä–∞–±–æ—Ç–∞—é—â–∏—Ö** –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ —ç—Ç–æ–π —Å–µ—Ç–∏. –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `vpn` –Ω–µ—Ç ‚Äî –∏–º—è `vpn` –Ω–µ —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è.
* –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ñ–∏–≥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∂—ë—Å—Ç–∫–æ —É–∫–∞–∑–∞–Ω `socks5h://vpn:1080`, –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±—É–¥—É—Ç –ø–∞–¥–∞—Ç—å (Connection refused / name not found). –û–Ω–∏ –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ ¬´–æ–±—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç¬ª, –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É–º–µ–µ—Ç fallback.
* –ï—Å–ª–∏ –∂–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ **–Ω–µ —á–µ—Ä–µ–∑ proxy**, –∞ –Ω–∞–ø—Ä—è–º—É—é, –µ–≥–æ egress –ø–æ–π–¥—ë—Ç —á–µ—Ä–µ–∑ Docker NAT –Ω–∞ —Ö–æ—Å—Ç –∏ –¥–∞–ª–µ–µ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç (–æ–±—ã—á–Ω—ã–π —Ö–æ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç).

### 3. –ï—Å–ª–∏ vpn –∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è

* –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `vpn` ‚Äî –æ–Ω –±—É–¥–µ—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—ë–Ω –∫ `vpn-net`, –ø–æ–ª—É—á–∏—Ç IP, Docker DNS –Ω–∞—á–Ω—ë—Ç —Ä–µ–∑–æ–ª–≤–∏—Ç—å `vpn` ‚Üí —Ç–æ–≥–¥–∞ `socks5h://vpn:1080` —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–º–æ–≥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (–µ—Å–ª–∏ –æ–Ω–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–µ–ª–∞—é—Ç –ø–æ–ø—ã—Ç–∫–∏). –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –æ–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏ –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—é—Ç –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–µ–Ω restart –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –ª–æ–≥–∏–∫–∞ reconnection.

---

## –ú–æ–∂–µ—Ç –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–∑–¥–∞—Ç—å docker network?

**–ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç: ‚ùå –Ω–µ—Ç, –∏ —ç—Ç–æ –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–æ**

**–ü–æ—á–µ–º—É?**

Docker network:

* —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **Docker daemon**
* **–ù–ï –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏**
* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä **–Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞** –∫ Docker API (–µ—Å–ª–∏ –≤—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –Ω–µ –ø—Ä–æ–±—Ä–æ—Å–∏–ª–∏ `/var/run/docker.sock`, —á—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ)

‚ùó –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –º–æ–∂–µ—Ç:

* —Å–æ–∑–¥–∞—Ç—å bridge-—Å–µ—Ç—å
* —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∞–≤–∞–º–∏ docker network
* –º–µ–Ω—è—Ç—å docker-level –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é

üìå **–î–∞–∂–µ `--cap-add NET_ADMIN` –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç** ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ –¥–ª—è *–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ* netns –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

---

## –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω: `external: true` + bootstrap compose

### –®–∞–≥ 0 ‚Äî —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ç—å **–æ–¥–∏–Ω —Ä–∞–∑**

```bash
docker network create vpn-net
```

(–¥–µ–ª–∞–µ—Ç—Å—è —Ä—É–∫–∞–º–∏ –∏–ª–∏ —Å–∫—Ä–∏–ø—Ç–æ–º)

---

## –ü–æ—á–µ–º—É –Ω–µ–ª—å–∑—è, —á—Ç–æ–±—ã vpn compose ¬´—Å–æ–∑–¥–∞–≤–∞–ª —Å–µ—Ç—å —Å–∞–º¬ª?

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ docker-compose **–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ç—å**, –ù–û:

‚ùå —Ç–æ–≥–¥–∞:

* —Å–µ—Ç—å –±—É–¥–µ—Ç **–ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ lifecycle compose**
* `docker compose down` ‚Üí —Å–µ—Ç—å —É–¥–∞–ª–∏—Ç—Å—è
* –¥—Ä—É–≥–∏–µ compose —Å–ª–æ–º–∞—é—Ç—Å—è

üìå –≠—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é:

> vpn –∂–∏–≤—ë—Ç –æ—Ç–¥–µ–ª—å–Ω–æ, dev/app –ø—Ä–∏—Ö–æ–¥—è—Ç –∏ —É—Ö–æ–¥—è—Ç
