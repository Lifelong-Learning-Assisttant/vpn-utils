–•–æ—Ä–æ—à–∏–π –≤–æ–ø—Ä–æ—Å ‚Äî —ç—Ç–æ **–∫–ª—é—á–µ–≤–∞—è —Ç–æ—á–∫–∞ –¥–æ–≤–µ—Ä–∏—è** –≤–æ –≤—Å–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ. –ù–∏–∂–µ ‚Äî —Ä–∞–∑–±–æ—Ä –±–µ–∑ –º–∞–≥–∏–∏, –Ω–∞ —É—Ä–æ–≤–Ω–µ Linux kernel, –∏–º–µ–Ω–Ω–æ –≤ –∫–æ–Ω—Ç–µ–∫—Å—Ç–µ **VPN-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**.

---

# –ß—Ç–æ —Ç–∞–∫–æ–µ `CAP_NET_ADMIN`

`CAP_NET_ADMIN` ‚Äî —ç—Ç–æ **Linux capability**, –∫–æ—Ç–æ—Ä–∞—è –¥–∞—ë—Ç –ø—Ä–æ—Ü–µ—Å—Å—É –ø—Ä–∞–≤–∞ **–∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ç–µ–≤–æ–π —Å—Ç–µ–∫** —è–¥—Ä–∞ **–≤ –ø—Ä–µ–¥–µ–ª–∞—Ö —Å–≤–æ–µ–≥–æ network namespace**.

–í–∞–∂–Ω–æ:

> —ç—Ç–æ **–Ω–µ root –∫–æ –≤—Å–µ–º—É**, –∞ *root –¥–ª—è —Å–µ—Ç–∏*.

---

## –ß—Ç–æ –∏–º–µ–Ω–Ω–æ —Ä–∞–∑—Ä–µ—à–∞–µ—Ç `CAP_NET_ADMIN`

–ü—Ä–æ—Ü–µ—Å—Å —Å `CAP_NET_ADMIN` **–≤–Ω—É—Ç—Ä–∏ network namespace** –º–æ–∂–µ—Ç:

### 1. –£–ø—Ä–∞–≤–ª—è—Ç—å —Å–µ—Ç–µ–≤—ã–º–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞–º–∏

* —Å–æ–∑–¥–∞–≤–∞—Ç—å / –ø–æ–¥–Ω–∏–º–∞—Ç—å / –æ–ø—É—Å–∫–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã

  * `tun0`, `tap0`
  * `veth`, `dummy`
* –º–µ–Ω—è—Ç—å MTU
* –Ω–∞–∑–Ω–∞—á–∞—Ç—å IP-–∞–¥—Ä–µ—Å–∞

üëâ **–ö—Ä–∏—Ç–∏—á–Ω–æ –¥–ª—è VPN**
`tun0` **–Ω–µ–≤–æ–∑–º–æ–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å** –±–µ–∑ `CAP_NET_ADMIN`.

---

### 2. –£–ø—Ä–∞–≤–ª—è—Ç—å –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–µ–π

* –¥–æ–±–∞–≤–ª—è—Ç—å / —É–¥–∞–ª—è—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã

  * `ip route add default via tun0`
* –º–µ–Ω—è—Ç—å policy routing (–≤ —Ä–∞–º–∫–∞—Ö ns)
* —Ä–∞–±–æ—Ç–∞—Ç—å —Å routing tables namespace

üëâ VPN –æ–±—è–∑–∞–Ω:

* –∑–∞–º–µ–Ω–∏—Ç—å default route
* –Ω–∞–ø—Ä–∞–≤–∏—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –≤ `tun0`

---

### 3. –£–ø—Ä–∞–≤–ª—è—Ç—å firewall (iptables/nftables)

* –¥–æ–±–∞–≤–ª—è—Ç—å/—É–¥–∞–ª—è—Ç—å –ø—Ä–∞–≤–∏–ª–∞
* NAT / MASQUERADE
* —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—è —Ç—Ä–∞—Ñ–∏–∫–∞

üëâ VPN-–∫–ª–∏–µ–Ω—Ç—ã —á–∞—Å—Ç–æ:

* —Å—Ç–∞–≤—è—Ç NAT –¥–ª—è `tun0`
* –∑–∞–ø—Ä–µ—â–∞—é—Ç egress –º–∏–º–æ VPN (kill-switch)

---

### 4. –£–ø—Ä–∞–≤–ª—è—Ç—å sysctl, —Å–≤—è–∑–∞–Ω–Ω—ã–º–∏ —Å —Å–µ—Ç—å—é

* `net.ipv4.ip_forward`
* `net.ipv4.conf.*`
* `rp_filter`, `accept_redirects`

---

### 5. –†–∞–±–æ—Ç–∞—Ç—å —Å TUN/TAP (`/dev/net/tun`)

* –æ—Ç–∫—Ä—ã–≤–∞—Ç—å TUN-—É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ
* —Å–æ–∑–¥–∞–≤–∞—Ç—å –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å–µ—Ç–µ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å

‚ö†Ô∏è **–í–∞–∂–Ω–æ**:
–î–∞–∂–µ –µ—Å–ª–∏ `/dev/net/tun` —Å–º–æ–Ω—Ç–∏—Ä–æ–≤–∞–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä, **–±–µ–∑ `CAP_NET_ADMIN`** –µ–≥–æ –æ—Ç–∫—Ä—ã—Ç—å –Ω–µ–ª—å–∑—è.

---

# –ü–æ—á–µ–º—É VPN-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –ù–£–ñ–ï–ù `CAP_NET_ADMIN`

–õ—é–±–æ–π userspace VPN (–≤–∫–ª—é—á–∞—è `adguardvpn-cli`) –¥–µ–ª–∞–µ—Ç —Å–ª–µ–¥—É—é—â–µ–µ:

1. –û—Ç–∫—Ä—ã–≤–∞–µ—Ç `/dev/net/tun`
2. –°–æ–∑–¥–∞—ë—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å `tun0`
3. –ù–∞–∑–Ω–∞—á–∞–µ—Ç IP
4. –ú–µ–Ω—è–µ—Ç routing table
5. –ò–Ω–æ–≥–¥–∞ ‚Äî –¥–æ–±–∞–≤–ª—è–µ—Ç firewall rules
6. –ü–æ–¥–º–µ–Ω—è–µ—Ç DNS / —Ä–µ–∑–æ–ª–≤–µ—Ä

üëâ **–í—Å–µ —ç—Ç–∏ –æ–ø–µ—Ä–∞—Ü–∏–∏ –∑–∞–ø—Ä–µ—â–µ–Ω—ã –±–µ–∑ `CAP_NET_ADMIN`**

---

# –í–∞–∂–Ω–æ: scope –¥–µ–π—Å—Ç–≤–∏—è

### `CAP_NET_ADMIN` –¥–µ–π—Å—Ç–≤—É–µ—Ç **—Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ network namespace –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**

–≠—Ç–æ –æ–∑–Ω–∞—á–∞–µ—Ç:

* ‚ùå –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä **–Ω–µ –º–æ–∂–µ—Ç**:

  * –º–µ–Ω—è—Ç—å –º–∞—Ä—à—Ä—É—Ç—ã —Ö–æ—Å—Ç–∞
  * —Ç—Ä–æ–≥–∞—Ç—å iptables —Ö–æ—Å—Ç–∞
  * –≤–∏–¥–µ—Ç—å —Å–µ—Ç–µ–≤—ã–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å—ã —Ö–æ—Å—Ç–∞
* ‚úÖ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä **–º–æ–∂–µ—Ç**:

  * –ø–æ–ª–Ω–æ—Å—Ç—å—é –∫–æ–Ω—Ç—Ä–æ–ª–∏—Ä–æ–≤–∞—Ç—å —Å–≤–æ—é –≤–∏—Ä—Ç—É–∞–ª—å–Ω—É—é —Å–µ—Ç—å

> **–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä ‚âà –≤–∏—Ä—Ç—É–∞–ª—å–Ω–∞—è –º–∞—à–∏–Ω–∞, –Ω–æ —Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ—Ç–∏**

---

# –ß–µ–º `CAP_NET_ADMIN` –ù–ï —è–≤–ª—è–µ—Ç—Å—è

| –ú–∏—Ñ                                                 | –†–µ–∞–ª—å–Ω–æ—Å—Ç—å                                   |
| --------------------------------------------------- | -------------------------------------------- |
| ¬´–≠—Ç–æ –ø–æ—á—Ç–∏ `--privileged`¬ª                          | ‚ùå –Ω–µ—Ç, `--privileged` –¥–∞—ë—Ç ~–≤—Å–µ capabilities |
| ¬´–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –º–æ–∂–µ—Ç —Å–ª–æ–º–∞—Ç—å —Å–µ—Ç—å —Ö–æ—Å—Ç–∞¬ª                | ‚ùå —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –¥–µ–ª–∏—Ç netns —Å —Ö–æ—Å—Ç–æ–º           |
| ¬´VPN –º–æ–∂–µ—Ç –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞—Ç—å —Ç—Ä–∞—Ñ–∏–∫ –¥—Ä—É–≥–∏—Ö –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤¬ª | ‚ùå –µ—Å–ª–∏ –æ–Ω–∏ –Ω–µ –≤ —Ç–æ–º –∂–µ netns                 |

---

# –ö–æ–≥–¥–∞ `CAP_NET_ADMIN` —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –æ–ø–∞—Å–Ω—ã–º

### ‚ùå –û–ø–∞—Å–Ω–æ, –µ—Å–ª–∏:

* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∏—Å–ø–æ–ª—å–∑—É–µ—Ç `network_mode: host`
* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—É –¥–∞–Ω `--privileged`
* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —à–∞—Ä–∏—Ç netns —Å —Ö–æ—Å—Ç–æ–º

–í —ç—Ç–∏—Ö —Å–ª—É—á–∞—è—Ö:

* VPN –º–æ–∂–µ—Ç –º–µ–Ω—è—Ç—å **—Ö–æ—Å—Ç–æ–≤—ã–µ –º–∞—Ä—à—Ä—É—Ç—ã**
* iptables —Ö–æ—Å—Ç–∞
* sniffing –≤–æ–∑–º–æ–∂–Ω–æ

üëâ **–í –≤–∞—à–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ —ç—Ç–æ–≥–æ –ù–ï–¢**

---

# –ü–æ—á–µ–º—É —ç—Ç–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ –≤ –≤–∞—à–µ–º –¥–∏–∑–∞–π–Ω–µ

–í–∞—à–∞ —Å—Ö–µ–º–∞:

```text
Host netns
 ‚îú‚îÄ docker bridge
 ‚îÇ   ‚îú‚îÄ app1
 ‚îÇ   ‚îú‚îÄ app2
 ‚îÇ   ‚îî‚îÄ vpn (CAP_NET_ADMIN)
 ‚îÇ
 ‚îî‚îÄ dev (network_mode: container:vpn)
```

–°–ª–µ–¥—Å—Ç–≤–∏—è:

* `vpn` –∏–º–µ–µ—Ç `CAP_NET_ADMIN` **—Ç–æ–ª—å–∫–æ –≤ —Å–≤–æ—ë–º netns**
* `dev` **–¥–µ–ª–∏—Ç** netns, –Ω–æ –Ω–µ –∏–º–µ–µ—Ç capability
* `app1/app2` ‚Äî –≤ –¥—Ä—É–≥–∏—Ö netns, –ø–æ–ª–Ω–æ—Å—Ç—å—é –∏–∑–æ–ª–∏—Ä–æ–≤–∞–Ω—ã
* —Ö–æ—Å—Ç –Ω–µ –∑–∞—Ç—Ä–æ–Ω—É—Ç

‚úîÔ∏è **–ë–µ–∑–æ–ø–∞—Å–Ω–æ –ø—Ä–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏**

---

# –ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –Ω–∞–±–æ—Ä –ø—Ä–∞–≤ –¥–ª—è VPN-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞

–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è:

```yaml
cap_add:
  - NET_ADMIN
devices:
  - /dev/net/tun:/dev/net/tun
security_opt:
  - no-new-privileges:true
```

‚ö†Ô∏è **–ù–ï –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ**:

* `--privileged`
* `SYS_ADMIN`
* `network_mode: host`

---

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –º–µ—Ä—ã —É—Å–∏–ª–µ–Ω–∏—è (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

### 1. –û–≥—Ä–∞–Ω–∏—á–∏—Ç—å iptables

* –µ—Å–ª–∏ VPN –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç firewall ‚Äî –∑–∞–ø—Ä–µ—Ç–∏—Ç—å `iptables` –±–∏–Ω–∞—Ä—å
* –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å seccomp profile

### 2. Read-only root FS

```yaml
read_only: true
```

(–µ—Å–ª–∏ adguardvpn-cli –ø–æ–∑–≤–æ–ª—è–µ—Ç)

### 3. Drop all capabilities, –∫—Ä–æ–º–µ –Ω—É–∂–Ω–æ–π

```yaml
cap_drop:
  - ALL
cap_add:
  - NET_ADMIN
```

---

# –ö—Ä–∞—Ç–∫–æ–µ —Ä–µ–∑—é–º–µ

* `CAP_NET_ADMIN` = **root-–¥–æ—Å—Ç—É–ø –∫ —Å–µ—Ç–∏ –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**
* **–æ–±—è–∑–∞—Ç–µ–ª–µ–Ω** –¥–ª—è –ª—é–±–æ–≥–æ VPN —Å `tun`
* **–±–µ–∑–æ–ø–∞—Å–µ–Ω**, –µ—Å–ª–∏:

  * –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –≤ `host` netns
  * –Ω–µ—Ç `--privileged`
  * –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω—ã–π docker bridge
* –í –≤–∞—à–µ–π –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–µ ‚Äî **–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –∏ –æ–∂–∏–¥–∞–µ–º—ã–π –≤—ã–±–æ—Ä**

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, –¥–∞–ª—å—à–µ –º–æ–∂–µ–º:

* —Ä–∞–∑–æ–±—Ä–∞—Ç—å, **—á—Ç–æ –∏–º–µ–Ω–Ω–æ adguardvpn-cli –¥–µ–ª–∞–µ—Ç —Å —Å–µ—Ç—å—é**
* –ø–æ–∫–∞–∑–∞—Ç—å `strace`/`ip monitor` ‚Äî –∫–∞–∫–∏–µ syscalls –æ–Ω –∏—Å–ø–æ–ª—å–∑—É–µ—Ç
* —Ä–∞–∑–æ–±—Ä–∞—Ç—å kill-switch –∏ –∫–∞–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å ¬´–Ω–µ—Ç egress –±–µ–∑ VPN¬ª

–°–∫–∞–∂–∏, –∫—É–¥–∞ –∏–¥—ë–º –¥–∞–ª—å—à–µ.
