# Docker ‚Äî VPN + Dev (Ubuntu)

–ù–∏–∂–µ ‚Äî –Ω–∞–±–æ—Ä —Ñ–∞–π–ª–æ–≤ –¥–ª—è —Å–±–æ—Ä–∫–∏ `VPN` –∏ `Dev` –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –∏ `docker-compose.yml` –¥–ª—è –∑–∞–ø—É—Å–∫–∞ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã, –æ–ø–∏—Å–∞–Ω–Ω–æ–π –≤–∞–º–∏.

> –§–∞–π–ª—ã –≤–∫–ª—é—á–∞—é—Ç:
>
> * `vpn/Dockerfile` ‚Äî –æ–±—Ä–∞–∑ –Ω–∞ Ubuntu —Å dnsmasq (AdGuard DNS), Dante (SOCKS5) –∏ Tinyproxy (HTTP). –¢–æ—á–∫–∞ –≤—Ö–æ–¥–∞: `entrypoint.sh`.
> * `vpn/danted.conf`, `vpn/tinyproxy.conf`, `vpn/dnsmasq.conf` ‚Äî —à–∞–±–ª–æ–Ω—ã –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–π.
> * `vpn/entrypoint.sh` ‚Äî –∑–∞–ø—É—Å–∫ vpn-–∫–ª–∏–µ–Ω—Ç–∞ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ `adguardvpn-cli`), dnsmasq, dante –∏ tinyproxy.
> * `dev/Dockerfile` ‚Äî –æ–±—Ä–∞–∑ —Ä–∞–∑—Ä–∞–±–æ—Ç—á–∏–∫–∞ (Ubuntu) —Å `code-server`/Kilo CLI –ø—Ä–∏–º–µ—á–∞–Ω–∏—è–º–∏; –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä `dev` –±—É–¥–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å —Å–µ—Ç–µ–≤–æ–π namespace –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `vpn`.
> * `docker-compose.yml` ‚Äî —Å–µ—Ä–≤–∏—Å—ã `vpn`, `dev` –∏ –ø—Ä–∏–º–µ—Ä `app1`. –°–µ—Ç—å `vpn-net` –¥–ª—è –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π, —á—Ç–æ–±—ã –æ–Ω–∏ –º–æ–≥–ª–∏ –æ–±—Ä–∞—â–∞—Ç—å—Å—è –∫ –ø—Ä–æ–∫—Å–∏ `vpn:1080`.

---

## –°—Ç—Ä—É–∫—Ç—É—Ä–∞ (–ø—Ä–µ–¥–ª–∞–≥–∞–µ–º–∞—è)

```
./docker-compose.yml
./vpn/
  Dockerfile
  entrypoint.sh
  danted.conf
  tinyproxy.conf
  dnsmasq.conf
./dev/
  Dockerfile
```

---

## vpn/Dockerfile

```Dockerfile
FROM ubuntu:22.04

ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update \
 && apt-get install -y --no-install-recommends \
    ca-certificates curl iproute2 iputils-ping procps \
    dnsmasq tinyproxy dante-server sudo \
 && rm -rf /var/lib/apt/lists/*

# –ö–æ–Ω—Ñ–∏–≥–∏ –∏ —Å–∫—Ä–∏–ø—Ç
COPY danted.conf /etc/danted.conf
COPY tinyproxy.conf /etc/tinyproxy/tinyproxy.conf
COPY dnsmasq.conf /etc/dnsmasq.conf
COPY entrypoint.sh /usr/local/bin/entrypoint.sh
RUN chmod +x /usr/local/bin/entrypoint.sh

EXPOSE 1080 1090

# –ù–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –ø–æ—Ä—Ç—ã –Ω–∞—Ä—É–∂—É –Ω–∞ —Ö–æ—Å—Ç ‚Äî –æ–Ω–∏ –Ω—É–∂–Ω—ã –¥–ª—è —Å–≤—è–∑–∏ –≤–Ω—É—Ç—Ä–∏ docker-—Å–µ—Ç–∏
CMD ["/usr/local/bin/entrypoint.sh"]
```

---

## vpn/danted.conf (—à–∞–±–ª–æ–Ω)

```text
# Dante SOCKS server config (dante-server)
logoutput: /var/log/danted.log
internal: 0.0.0.0 port = 1080
external: tun0
method: none
user.privileged: root
user.notprivileged: nobody

client pass {
  from: 0.0.0.0/0 to: 0.0.0.0/0
}

socks pass {
  from: 0.0.0.0/0 to: 0.0.0.0/0
}
```

> –ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: `external: tun0` –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ –≤—ã—Ö–æ–¥—è—â–∏–π —Ç—Ä–∞—Ñ–∏–∫ dante –±—É–¥–µ—Ç –∏–¥—Ç–∏ —á–µ—Ä–µ–∑ VPN-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å. –ï—Å–ª–∏ tun0 –µ—â—ë –Ω–µ –ø–æ–¥–Ω—è—Ç –Ω–∞ –º–æ–º–µ–Ω—Ç —Å—Ç–∞—Ä—Ç–∞, entrypoint.sh –∂–¥—ë—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å.

---

## vpn/tinyproxy.conf (—à–∞–±–ª–æ–Ω)

```text
User nobody
Group nogroup
Port 1090
Timeout 600
DefaultErrorFile "/usr/share/tinyproxy/default.html"
StatFile "/usr/share/tinyproxy/stats.html"
Logfile "/var/log/tinyproxy/tinyproxy.log"
LogLevel Notice
PidFile "/var/run/tinyproxy.pid"
MaxClients 100
MinSpareServers 5
MaxSpareServers 20
StartServers 10

# allow local docker networks (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é —Ä–∞–∑—Ä–µ—à–∞–µ–º –≤—Å–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–µ –∑–∞–ø—Ä–æ—Å—ã)
Allow 127.0.0.1
Allow 0.0.0.0/0

# –ü—Ä–æ—Å–ª—É—à–∏–≤–∞—Ç—å –Ω–∞ –≤—Å–µ—Ö –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞—Ö –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî dev (network_mode: container:vpn) –∏ –¥—Ä—É–≥–∏–µ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –ø–æ–¥–∫–ª—é—á—ë–Ω–Ω—ã–µ –∫ vpn-net —Å–º–æ–≥—É—Ç –æ–±—Ä–∞—â–∞—Ç—å—Å—è –ø–æ –∏–º–µ–Ω–∏ 'vpn:1090'
Listen 0.0.0.0

# –†–∞–∑—Ä–µ—à–∞–µ–º CONNECT (HTTPS)
ConnectPort 443
ConnectPort 563
ConnectPort 80
```

---

## vpn/dnsmasq.conf (—à–∞–±–ª–æ–Ω ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—É–±–ª–∏—á–Ω—ã–µ AdGuard DNS —Å–µ—Ä–≤–µ—Ä–∞)

```text
# dnsmasq –ø—Ä–æ—Å—Ç–∞—è –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∑–æ–ª–≤–µ—Ä–∞
no-resolv
server=94.140.14.14
server=94.140.15.15
listen-address=127.0.0.1
bind-interfaces
cache-size=1000
```

> –ï—Å–ª–∏ —É –≤–∞—Å –µ—Å—Ç—å —Å–≤–æ–π AdGuard DNS/AdGuard VPN –∫–ª–∏–µ–Ω—Ç ‚Äî –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å server= –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—ã–π –∞–¥—Ä–µ—Å.

---

## vpn/entrypoint.sh

```bash
#!/bin/bash
set -e

# –õ–æ–≥ –≤ stdout
mkdir -p /var/log

# 1) –û–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ: –∑–∞–ø—É—Å—Ç–∏—Ç—å VPN-–∫–ª–∏–µ–Ω—Ç (adguardvpn-cli –∏–ª–∏ –ª—é–±–æ–π –¥—Ä—É–≥–æ–π)
# –ï—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ adguardvpn-cli –∏ –ø–µ—Ä–µ–¥–∞—ë—Ç–µ —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ ADGUARDVPN_TOKEN, –ø–æ–ø—ã—Ç–∫–∞ —Å–æ–µ–¥–∏–Ω–∏—Ç—å—Å—è –±—É–¥–µ—Ç –ø—Ä–µ–¥–ø—Ä–∏–Ω—è—Ç–∞.
# –ü—Ä–∏–º–µ—Ä: docker compose run -e ADGUARDVPN_TOKEN=... vpn

if [ -n "${ADGUARDVPN_TOKEN:-}" ]; then
  echo "[entrypoint] ADGUARDVPN_TOKEN –∑–∞–¥–∞–Ω ‚Äî –ø—ã—Ç–∞–µ–º—Å—è –∑–∞–ø—É—Å—Ç–∏—Ç—å adguardvpn-cli"
  if command -v adguardvpn-cli >/dev/null 2>&1; then
    adguardvpn-cli login --token "$ADGUARDVPN_TOKEN" || true
    adguardvpn-cli connect --tcp || true
  else
    echo "[entrypoint] adguardvpn-cli –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ. –ü—Ä–æ–ø—É—Å–∫–∞–µ–º –∑–∞–ø—É—Å–∫ VPN-–∫–ª–∏–µ–Ω—Ç–∞."
  fi
fi

# 2) –ó–∞–ø—É—Å–∫–∞–µ–º dnsmasq (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∑–æ–ª–≤–µ—Ä) ‚Äî –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç —Ä–µ–∑–æ–ª–≤ –≤–Ω—É—Ç—Ä–∏ vpn-namespace
if [ -f /etc/dnsmasq.conf ]; then
  echo "[entrypoint] —Å—Ç–∞—Ä—Ç dnsmasq"
  pkill dnsmasq || true
  dnsmasq --conf-file=/etc/dnsmasq.conf || true
fi

# 3) –ñ–¥—ë–º –ø–æ—è–≤–ª–µ–Ω–∏—è tun0 (–µ—Å–ª–∏ –æ–∂–∏–¥–∞–µ—Ç—Å—è VPN-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å)
# –ñ–¥—ë–º –º–∞–∫—Å–∏–º—É–º 30s ‚Äî –µ—Å–ª–∏ –Ω–µ—Ç tun0, –ø—Ä–æ–¥–æ–ª–∂–∏–º, –Ω–æ danted external –º–æ–∂–µ—Ç –±—ã—Ç—å –Ω–µ–∫–æ—Ä—Ä–µ–∫—Ç–µ–Ω
for i in {1..30}; do
  if ip link show tun0 >/dev/null 2>&1; then
    echo "[entrypoint] –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å tun0 –Ω–∞–π–¥–µ–Ω"
    break
  fi
  echo "[entrypoint] –∂–¥—ë–º tun0... ($i/30)"
  sleep 1
done

# 4) –ó–∞–ø—É—Å–∫–∞–µ–º danted (socks5)
if [ -f /etc/danted.conf ]; then
  echo "[entrypoint] —Å—Ç–∞—Ä—Ç danted"
  pkill danted || true
  /usr/sbin/danted -f /etc/danted.conf &
fi

# 5) –ó–∞–ø—É—Å–∫–∞–µ–º tinyproxy (http)
if [ -f /etc/tinyproxy/tinyproxy.conf ]; then
  echo "[entrypoint] —Å—Ç–∞—Ä—Ç tinyproxy"
  pkill tinyproxy || true
  tinyproxy -c /etc/tinyproxy/tinyproxy.conf &
fi

# 6) –í—ã–≤–æ–¥ –ª–æ–≥–æ–≤ –≤ foreground (–ø—Ä–æ—Å—Ç–µ–π—à–∏–π —Å–ø–æ—Å–æ–± –¥–µ—Ä–∂–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –∂–∏–≤—ã–º)
# –í—ã–≤–æ–¥–∏–º –æ—Å–Ω–æ–≤–Ω—ã–µ –ª–æ–≥–∏ –≤ stdout –¥–ª—è —É–¥–æ–±—Å—Ç–≤–∞
sleep 1

# tail –ª–æ–≥–æ–≤ –ø–æ –≤—Å–µ–º –≤–æ–∑–º–æ–∂–Ω—ã–º —Ñ–∞–π–ª–∞–º
mkdir -p /var/log/tinyproxy /var/log
# –ù–µ –≤—Å–µ —Ñ–∞–π–ª—ã –º–æ–≥—É—Ç —Å—É—â–µ—Å—Ç–≤–æ–≤–∞—Ç—å —Å—Ä–∞–∑—É ‚Äî –∏—Å–ø–æ–ª—å–∑—É–µ–º tail -F
tail -F /var/log/danted.log /var/log/tinyproxy/tinyproxy.log || true

# –ï—Å–ª–∏ tail –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Ç–æ–∂–µ –∑–∞–≤–µ—Ä—à–∏—Ç—Å—è
```

---

## dev/Dockerfile

```Dockerfile
FROM ubuntu:22.04
ENV DEBIAN_FRONTEND=noninteractive

RUN apt-get update \
 && apt-get install -y --no-install-recommends \
    ca-certificates curl gnupg git build-essential sudo iproute2 procps \
 && rm -rf /var/lib/apt/lists/*

# –ü–∞–ø–∫–∞ —Ä–∞–±–æ—á–µ–≥–æ –ø—Ä–æ–µ–∫—Ç–∞ (–ø—Ä–∏–º–µ—Ä—ã)
ARG USER=developer
ARG UID=1000
RUN useradd -m -u ${UID} -s /bin/bash ${USER} && echo "${USER} ALL=(ALL) NOPASSWD:ALL" > /etc/sudoers.d/${USER}
USER ${USER}
WORKDIR /home/${USER}/project

# --- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ —É—Å—Ç–∞–Ω–æ–≤–∫–µ code-server –∏ Kilo CLI ---
# –ú—ã –Ω–µ —Å—Ç–∞–≤–∏–º code-server –∏ kilo –≤ –æ–±—Ä–∞–∑ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî —Ä–∞–∑–Ω—ã–µ –ø—Ä–æ–µ–∫—Ç—ã —Ç—Ä–µ–±—É—é—Ç —Ä–∞–∑–Ω–æ–π –≤–µ—Ä—Å–∏–∏ –∏ token'–æ–≤.
# –ù–∏–∂–µ ‚Äî –∫–æ–º–∞–Ω–¥—ã, –∫–æ—Ç–æ—Ä—ã–µ –º–æ–∂–Ω–æ –≤—ã–ø–æ–ª–Ω–∏—Ç—å –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (–∏–ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –≤ Dockerfile –ø—Ä–∏ –∂–µ–ª–∞–Ω–∏–∏):
#
# 1) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å code-server (–ø—Ä–∏–º–µ—Ä):
#   curl -fsSL https://code-server.dev/install.sh | sh
#
# 2) –£—Å—Ç–∞–Ω–æ–≤–∏—Ç—å Kilo CLI (–ø—Ä–∏–º–µ—Ä):
#   curl -fsSL https://get.kilo.sh | sh
#
# 3) –ù–∞—Å—Ç—Ä–æ–∏—Ç—å HTTP_PROXY/HTTPS_PROXY (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ), —Å–º. docker-compose ‚Äî dev –±—É–¥–µ—Ç share net namespace —Å vpn.

CMD ["/bin/bash"]
```

---

## docker-compose.yml

```yaml
version: '3.8'

services:
  vpn:
    build: ./vpn
    container_name: vpn
    cap_add:
      - NET_ADMIN
    cap_drop:
      - ALL
    devices:
      - /dev/net/tun:/dev/net/tun
    # –ù–µ –∏—Å–ø–æ–ª—å–∑—É–µ–º privileged –∏–ª–∏ network_mode: host
    restart: unless-stopped
    networks:
      - vpn-net
    # –ù–ï –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–µ–º –Ω–∏–∫–∞–∫–∏–µ –ø–æ—Ä—Ç—ã –Ω–∞ —Ö–æ—Å—Ç (security):
    # ports: []
    volumes:
      - ./vpn/danted.conf:/etc/danted.conf:ro
      - ./vpn/tinyproxy.conf:/etc/tinyproxy/tinyproxy.conf:ro
      - ./vpn/dnsmasq.conf:/etc/dnsmasq.conf:ro

  dev:
    build: ./dev
    container_name: dev
    # dev –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–µ—Ç–µ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ vpn-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞
    network_mode: "container:vpn"
    depends_on:
      - vpn
    # –•—Ä–∞–Ω–∏–º developer credentials –≤–Ω—É—Ç—Ä–∏ ephemeral volume ‚Äî –Ω–µ –º–æ–Ω—Ç–∏—Ä—É–µ–º —Ö–æ—Å—Ç–æ–≤—É—é home –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
    volumes:
      - dev-data:/home/developer
      - ./project:/home/developer/project:cached
    environment:
      # code-server –∏ CLI –≤–Ω—É—Ç—Ä–∏ dev —É–≤–∏–¥—è—Ç localhost:1090 –∫–∞–∫ tinyproxy –≤–Ω—É—Ç—Ä–∏ vpn namespace
      - HTTP_PROXY=http://127.0.0.1:1090
      - HTTPS_PROXY=http://127.0.0.1:1090
      - NO_PROXY=localhost,127.0.0.1
    restart: unless-stopped

  app1:
    image: ubuntu:22.04
    container_name: app1
    command: ["/bin/sh", "-c", "sleep infinity"]
    networks:
      - vpn-net
    environment:
      # –ü—Ä–∏–º–µ—Ä –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è SOCKS –∏ HTTP proxy
      - ALL_PROXY=socks5h://vpn:1080
      - HTTP_PROXY=http://vpn:1090
      - HTTPS_PROXY=http://vpn:1090
    volumes:
      - ./app1:/app

networks:
  vpn-net:
    driver: bridge

volumes:
  dev-data:
```

---

## –ö–∞–∫ –∑–∞–ø—É—Å—Ç–∏—Ç—å ‚Äî quickstart

1. –°–±–æ—Ä–∫–∞ –∏ –∑–∞–ø—É—Å–∫:

```bash
docker compose build
docker compose up -d
```

2. –ü—Ä–æ–≤–µ—Ä–∫–∏ (–∏–∑ `dev` –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞, —Ç.–∫. –æ–Ω —à–∞—Ä–∏—Ç netns —Å `vpn`):

```bash
# –í—ã–ø–æ–ª–Ω–∏—Ç—å –≤ –æ—Ç–¥–µ–ª—å–Ω–æ–º —Ç–µ—Ä–º–∏–Ω–∞–ª–µ –ø–æ—Å–ª–µ —Å—Ç–∞—Ä—Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤
docker exec -it dev bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π IP —á–µ—Ä–µ–∑ tinyproxy
curl --proxy http://127.0.0.1:1090 https://api.ipify.org
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á–µ—Ä–µ–∑ socks5 (–Ω–∞–ø—Ä–∏–º–µ—Ä, —Å curl + proxychains –∏–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ, –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—â–µ–µ socks5h)
```

---

## –í–∞–∂–Ω–æ ‚Äî –ø—Ä–∏–º–µ—á–∞–Ω–∏—è –∏ –≤–∞—Ä–∏–∞–Ω—Ç—ã –¥–æ—Ä–∞–±–æ—Ç–∫–∏

* **adguardvpn-cli:** –í Dockerfile —è –Ω–µ —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞—é —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π VPN-–∫–ª–∏–µ–Ω—Ç (adguardvpn-cli), —Ç.–∫. –æ–Ω –º–æ–∂–µ—Ç —Ç—Ä–µ–±–æ–≤–∞—Ç—å –ø—Ä–∏–≤–∞—Ç–Ω—ã—Ö –ø–∞–∫–µ—Ç–æ–≤/–∫–ª—é—á–µ–π –∏ –ª–∏—Ü–µ–Ω–∑–∏–π. –í `entrypoint.sh` –µ—Å—Ç—å —Ç–æ—á–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è ‚Äî –µ—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ `adguardvpn-cli`, –¥–æ–±–∞–≤—å—Ç–µ —à–∞–≥ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ –≤ Dockerfile –∏ —É—Å—Ç–∞–Ω–æ–≤–∏—Ç–µ —Ç–æ–∫–µ–Ω —á–µ—Ä–µ–∑ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é –æ–∫—Ä—É–∂–µ–Ω–∏—è `ADGUARDVPN_TOKEN`.
* **DNS:** –í –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –ø–æ–¥–Ω—è—Ç `dnsmasq`, –∫–æ—Ç–æ—Ä—ã–π –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –ø—É–±–ª–∏—á–Ω—ã–µ AdGuard DNS (94.140.14.14/15). –≠—Ç–æ –æ–±–µ—Å–ø–µ—á–∏–≤–∞–µ—Ç, —á—Ç–æ —Ä–µ–∑–æ–ª–≤ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ vpn-namespace.
* **–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:** –Ω–µ –ø—Ä–æ–±—Ä–∞—Å—ã–≤–∞–π—Ç–µ –ø—Ä–æ–∫—Å–∏-–ø–æ—Ä—Ç—ã –Ω–∞ —Ö–æ—Å—Ç. –†–∞–∑—Ä–µ—à–µ–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞ –Ω–∞ –ø—Ä–æ–∫—Å–∏ –º–æ–∂–Ω–æ –æ–≥—Ä–∞–Ω–∏—á–∏—Ç—å –≤ –∫–æ–Ω—Ñ–∏–≥–µ tinyproxy/danted.
* **–ú–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—è:** –º—ã **–Ω–µ** —Ç—Ä–æ–≥–∞–µ–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ —Ç–∞–±–ª–∏—Ü—ã –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏–∏ —Ö–æ—Å—Ç–∞ ‚Äî –≤—Å—ë –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤–Ω—É—Ç—Ä–∏ vpn –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (tun0).
* **Dev credentials:** developer credentials —Ö—Ä–∞–Ω—è—Ç—Å—è –≤ `dev-data` volume; –µ—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ anonymous volume –∏–ª–∏ tmpfs –¥–ª—è –ø–æ–ª–Ω–æ–≥–æ –∏—Å—á–µ–∑–Ω–æ–≤–µ–Ω–∏—è –ø—Ä–∏ rm.
* **Apps:** –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –ø–æ–¥–∫–ª—é—á–∞—é—Ç—Å—è –∫ `vpn-net` –∏ –¥–æ–ª–∂–Ω—ã –Ω–∞–ø—Ä–∞–≤–ª—è—Ç—å LLM-–≤—ã–∑–æ–≤—ã –Ω–∞ `socks5h://vpn:1080` –∏–ª–∏ `http://vpn:1090`. –î–ª—è Python: –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ `socks5h` —á—Ç–æ–±—ã DNS —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏–ª–æ –≤–Ω—É—Ç—Ä–∏ VPN.

–û—Ç–ª–∏—á–Ω—ã–π –≤–æ–ø—Ä–æ—Å ‚Äî —ç—Ç–æ –∫–∞–∫ —Ä–∞–∑ –≤–∞–∂–Ω—ã–π **–∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–π –º–æ–º–µ–Ω—Ç Docker**, –∏ —Ç—É—Ç –µ—Å—Ç—å —á—ë—Ç–∫–∏–µ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –∏ —Ä–∞–±–æ—á–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã.

–†–∞–∑–±–µ—Ä—É –ø–æ –ø–æ—Ä—è–¥–∫—É –∏ —á–µ—Å—Ç–Ω–æ.

---

## 1Ô∏è‚É£ –ù–µ–∑–∞–≤–∏—Å–∏–º—ã–µ docker-compose –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ ‚Äî **–¥–∞, —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ –∏ –ø—Ä–∞–≤–∏–ª—å–Ω–æ**

–í–∞—à–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ:

> vpn –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
> dev –ø–æ–¥–Ω–∏–º–∞–µ—Ç—Å—è –æ—Ç–¥–µ–ª—å–Ω–æ
> dev –º–æ–∂–Ω–æ –æ—Å—Ç–∞–Ω–æ–≤–∏—Ç—å/—É–¥–∞–ª–∏—Ç—å ‚Äî vpn –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å

‚úÖ **–≠—Ç–æ –ø–æ–ª–Ω–æ—Å—Ç—å—é –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è Docker‚Äô–æ–º**
‚úÖ **–≠—Ç–æ —Ö–æ—Ä–æ—à–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–ª—è infra / dev split**

–ö–ª—é—á–µ–≤–∞—è –∏–¥–µ—è:

* **vpn ‚Äî –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–Ω—ã–π —Å–µ—Ä–≤–∏—Å**
* **dev / app ‚Äî –∫–ª–∏–µ–Ω—Ç—ã –∏–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä—ã**

---

## 2Ô∏è‚É£ –ú–æ–∂–µ—Ç –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–∞–º —Å–æ–∑–¥–∞—Ç—å docker network?

**–ö–æ—Ä–æ—Ç–∫–∏–π –æ—Ç–≤–µ—Ç: ‚ùå –Ω–µ—Ç, –∏ —ç—Ç–æ –ø—Ä–∏–Ω—Ü–∏–ø–∏–∞–ª—å–Ω–æ**

### –ü–æ—á–µ–º—É?

Docker network:

* —Å–æ–∑–¥–∞—ë—Ç—Å—è –∏ —É–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è **Docker daemon**
* **–ù–ï –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏**
* –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä **–Ω–µ –∏–º–µ–µ—Ç –¥–æ—Å—Ç—É–ø–∞** –∫ Docker API (–µ—Å–ª–∏ –≤—ã —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ –Ω–µ –ø—Ä–æ–±—Ä–æ—Å–∏–ª–∏ `/var/run/docker.sock`, —á—Ç–æ –Ω–µ–±–µ–∑–æ–ø–∞—Å–Ω–æ)

> ‚ùó –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –º–æ–∂–µ—Ç:
>
> * —Å–æ–∑–¥–∞—Ç—å bridge-—Å–µ—Ç—å
> * —É–ø—Ä–∞–≤–ª—è—Ç—å –ø—Ä–∞–≤–∞–º–∏ docker network
> * –º–µ–Ω—è—Ç—å docker-level –º–∞—Ä—à—Ä—É—Ç–∏–∑–∞—Ü–∏—é

üìå **–î–∞–∂–µ `--cap-add NET_ADMIN` –Ω–µ –ø–æ–º–æ–≥–∞–µ—Ç** ‚Äî —ç—Ç–æ —Ç–æ–ª—å–∫–æ –¥–ª—è *–≤–Ω—É—Ç—Ä–µ–Ω–Ω–µ–≥–æ* netns –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞.

---

## 3Ô∏è‚É£ –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω: `external: true` + bootstrap compose

### ‚úî –†–µ–∫–æ–º–µ–Ω–¥—É–µ–º–∞—è —Å—Ö–µ–º–∞ (production-grade)

#### –®–∞–≥ 0 ‚Äî —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ç—å **–æ–¥–∏–Ω —Ä–∞–∑**

```bash
docker network create vpn-net
```

(–¥–µ–ª–∞–µ—Ç—Å—è —Ä—É–∫–∞–º–∏ –∏–ª–∏ —Å–∫—Ä–∏–ø—Ç–æ–º)

---

## 4Ô∏è‚É£ docker-compose –¥–ª—è VPN (–æ—Ç–¥–µ–ª—å–Ω—ã–π)

### `vpn/docker-compose.yml`

```yaml
version: "3.8"

services:
  vpn:
    container_name: vpn
    build: .
    cap_add:
      - NET_ADMIN
    cap_drop:
      - ALL
    devices:
      - /dev/net/tun:/dev/net/tun
    restart: unless-stopped
    networks:
      - vpn-net
    volumes:
      - ./danted.conf:/etc/danted.conf:ro
      - ./tinyproxy.conf:/etc/tinyproxy/tinyproxy.conf:ro
      - ./dnsmasq.conf:/etc/dnsmasq.conf:ro

networks:
  vpn-net:
    external: true
```

üîë **–í–∞–∂–Ω–æ**

* compose **–ù–ï —Å–æ–∑–¥–∞—ë—Ç —Å–µ—Ç—å**
* –æ–Ω –æ–∂–∏–¥–∞–µ—Ç, —á—Ç–æ `vpn-net` —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
* vpn –º–æ–∂–µ—Ç –±—ã—Ç—å –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ

---

## 5Ô∏è‚É£ docker-compose –¥–ª—è dev (–æ—Ç–¥–µ–ª—å–Ω—ã–π)

### `dev/docker-compose.yml`

```yaml
version: "3.8"

services:
  dev:
    container_name: dev
    build: .
    network_mode: "container:vpn"
    restart: unless-stopped
    volumes:
      - dev-data:/home/developer
      - ./project:/home/developer/project
    environment:
      - HTTP_PROXY=http://127.0.0.1:1090
      - HTTPS_PROXY=http://127.0.0.1:1090
      - NO_PROXY=localhost,127.0.0.1

volumes:
  dev-data:
```

### –ß—Ç–æ —ç—Ç–æ –¥–∞—ë—Ç

* dev **–ù–ï –∑–∞–≤–∏—Å–∏—Ç –æ—Ç compose vpn**
* –Ω–æ **–∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Ñ–∞–∫—Ç–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `vpn`**
* `docker compose up dev` —É–ø–∞–¥—ë—Ç, –µ—Å–ª–∏ `vpn` –Ω–µ –∑–∞–ø—É—â–µ–Ω ‚Äî –∏ —ç—Ç–æ **–ø—Ä–∞–≤–∏–ª—å–Ω–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ**

---

## 6Ô∏è‚É£ App-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã ‚Äî —Ç—Ä–µ—Ç–∏–π –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–π compose

### `apps/docker-compose.yml`

```yaml
version: "3.8"

services:
  app1:
    image: ubuntu:22.04
    command: sleep infinity
    networks:
      - vpn-net
    environment:
      - ALL_PROXY=socks5h://vpn:1080

networks:
  vpn-net:
    external: true
```

---

## 7Ô∏è‚É£ –ü–æ—á–µ–º—É **–Ω–µ–ª—å–∑—è**, —á—Ç–æ–±—ã vpn compose ¬´—Å–æ–∑–¥–∞–≤–∞–ª —Å–µ—Ç—å —Å–∞–º¬ª?

–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏ docker-compose **–º–æ–∂–µ—Ç —Å–æ–∑–¥–∞—Ç—å —Å–µ—Ç—å**, –ù–û:

‚ùå —Ç–æ–≥–¥–∞:

* —Å–µ—Ç—å –±—É–¥–µ—Ç **–ø—Ä–∏–≤—è–∑–∞–Ω–∞ –∫ lifecycle compose**
* `docker compose down` ‚Üí —Å–µ—Ç—å —É–¥–∞–ª–∏—Ç—Å—è
* –¥—Ä—É–≥–∏–µ compose —Å–ª–æ–º–∞—é—Ç—Å—è

üìå –≠—Ç–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏—Ç –≤–∞—à–µ–º—É —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é:

> vpn –∂–∏–≤—ë—Ç –æ—Ç–¥–µ–ª—å–Ω–æ, dev/app –ø—Ä–∏—Ö–æ–¥—è—Ç –∏ —É—Ö–æ–¥—è—Ç

---

## 8Ô∏è‚É£ –ï—Å–ª–∏ –æ—á–µ–Ω—å —Ö–æ—á–µ—Ç—Å—è ¬´–∞–≤—Ç–æ—Å–æ–∑–¥–∞–Ω–∏–µ¬ª ‚Äî –±–µ–∑–æ–ø–∞—Å–Ω—ã–π –∫–æ–º–ø—Ä–æ–º–∏—Å—Å

### –í–∞—Ä–∏–∞–Ω—Ç A ‚Äî bootstrap-—Å–∫—Ä–∏–ø—Ç (—Ä–µ–∫–æ–º–µ–Ω–¥—É—é)

```bash
#!/usr/bin/env bash
set -e

docker network inspect vpn-net >/dev/null 2>&1 || \
  docker network create vpn-net

docker compose up -d
```

‚úî –ø—Ä–æ—Å—Ç–æ
‚úî –ø—Ä–æ–∑—Ä–∞—á–Ω–æ
‚úî –±–µ–∑–æ–ø–∞—Å–Ω–æ
‚úî production-friendly

---

### –í–∞—Ä–∏–∞–Ω—Ç B ‚Äî docker-compose profile (–º–µ–Ω–µ–µ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ)

–ú–æ–∂–Ω–æ —Å–¥–µ–ª–∞—Ç—å –æ—Ç–¥–µ–ª—å–Ω—ã–π compose **—Ç–æ–ª—å–∫–æ –¥–ª—è —Å–µ—Ç–∏**, –Ω–æ —ç—Ç–æ –ø–æ —Å—É—Ç–∏ —Ç–æ—Ç –∂–µ bootstrap.

---

## 9Ô∏è‚É£ –í–ê–ñ–ù–û: –ø—Ä–∞–≤–∞ –Ω–∞ —Å–µ—Ç—å

Docker network **–Ω–µ –∏–º–µ–µ—Ç ACL**.

–ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –ª–∏–±–æ:

* –ø–æ–¥–∫–ª—é—á—ë–Ω
* –ª–∏–±–æ –Ω–µ—Ç

–û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è –¥–µ–ª–∞—é—Ç—Å—è:

* —á–µ—Ä–µ–∑ **proxy ACL (danted / tinyproxy)**
* –∏–ª–∏ —á–µ—Ä–µ–∑ **–æ—Ç–¥–µ–ª—å–Ω—ã–µ —Å–µ—Ç–∏** (`vpn-net`, `internal-net`, `public-net`)

–ò –≤—ã —É–∂–µ –≤—ã–±—Ä–∞–ª–∏ –ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø—É—Ç—å üëç

---

## 10Ô∏è‚É£ –ò—Ç–æ–≥ (–∫–æ—Ä–æ—Ç–∫–æ)

| –í–æ–ø—Ä–æ—Å                                                | –û—Ç–≤–µ—Ç                          |
| ----------------------------------------------------- | ------------------------------ |
| –ú–æ–∂–Ω–æ –ª–∏ –ø–æ–¥–Ω–∏–º–∞—Ç—å –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã –Ω–µ–∑–∞–≤–∏—Å–∏–º—ã–º–∏ compose?   | ‚úÖ –î–∞, –∏–¥–µ–∞–ª—å–Ω–æ                 |
| –ú–æ–∂–µ—Ç –ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–æ–∑–¥–∞—Ç—å docker network?            | ‚ùå –ù–µ—Ç                          |
| –ú–æ–∂–Ω–æ –ª–∏, —á—Ç–æ–±—ã vpn ¬´–≤–ª–∞–¥–µ–ª¬ª —Å–µ—Ç—å—é?                   | ‚ùå –ù–µ–ª—å–∑—è                       |
| –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ç—Ç–µ—Ä–Ω                                    | `external network` + bootstrap |
| `network_mode: container:vpn` —Ä–∞–±–æ—Ç–∞–µ—Ç –º–µ–∂–¥—É compose? | ‚úÖ –î–∞                           |
| VPN –∂–∏–≤—ë—Ç, dev –ø–∞–¥–∞–µ—Ç ‚Äî –≤—Å—ë –æ–∫?                       | ‚úÖ –î–∞                           |

---

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å, —Å–ª–µ–¥—É—é—â–∏–º —à–∞–≥–æ–º –º–æ–≥—É:

* üß± –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å **infra-repo layout** (`infra/vpn`, `infra/dev`, `infra/apps`)
* üîê —É–∂–µ—Å—Ç–æ—á–∏—Ç—å `danted` ACL (—Ä–∞–∑—Ä–µ—à–∞—Ç—å —Ç–æ–ª—å–∫–æ `vpn-net`)
* üß™ –¥–∞—Ç—å **–Ω–∞–±–æ—Ä healthchecks**, —á—Ç–æ–±—ã dev –∂–¥–∞–ª –ø–æ–¥–Ω—è—Ç–∏—è proxy
* üì¶ —Å–æ–±—Ä–∞—Ç—å **Makefile / taskfile** –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –≤—Å–µ–º —ç—Ç–∏–º

–ü—Ä–æ—Å—Ç–æ —Å–∫–∞–∂–∏ üëç


–û—Ç–ª–∏—á–Ω–æ ‚Äî —Ä–∞–∑–±–µ—Ä—ë–º –≤—Å—ë –ø–æ-–ø–æ—Ä—è–¥–∫—É –∏ –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö —Ñ–∞–∫—Ç–∞—Ö, —á—Ç–æ–±—ã –Ω–µ –±—ã–ª–æ —Å—é—Ä–ø—Ä–∏–∑–æ–≤ –≤ –ø—Ä–æ–¥–∞–∫—à–µ–Ω–µ.

---

## –ö–æ—Ä–æ—Ç–∫–∏–µ –æ—Ç–≤–µ—Ç—ã (–¥–æ –¥–µ—Ç–∞–ª–µ–π)

* –î–∞ ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è **–º–æ–≥—É—Ç** –∑–∞–ø—É—Å–∫–∞—Ç—å—Å—è –∏–∑ —Å–≤–æ–µ–≥–æ `docker-compose`, –µ—Å–ª–∏ —Å–µ—Ç–µ–≤–æ–µ –ø—Ä–æ—Å—Ç—Ä–∞–Ω—Å—Ç–≤–æ (docker network) —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç.
* **–ï—Å–ª–∏ —Å–µ—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç** –∏ –≤ `docker-compose.yml` –æ–Ω–∞ –æ–±—ä—è–≤–ª–µ–Ω–∞ –∫–∞–∫ `external: true`, —Ç–æ `docker compose up` —É–ø–∞–¥—ë—Ç —Å –æ—à–∏–±–∫–æ–π.
* **–ï—Å–ª–∏ —Å–µ—Ç—å –µ—Å—Ç—å**, –Ω–æ `vpn`-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –Ω–µ –∑–∞–ø—É—â–µ–Ω ‚Äî —Å–µ—Ç—å –ø—Ä–æ—Å—Ç–æ –±—É–¥–µ—Ç ¬´–ø—É—Å—Ç–æ–π¬ª (–æ–±—ã—á–Ω—ã–π bridge). App-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã —Å–º–æ–≥—É—Ç –æ–±–º–µ–Ω–∏–≤–∞—Ç—å—Å—è –º–µ–∂–¥—É —Å–æ–±–æ–π, –Ω–æ –∏–º—è `vpn` –≤ Docker-DNS **–Ω–µ –±—É–¥–µ—Ç —Ä–µ–∑–æ–ª–≤–∏—Ç—å—Å—è** –≤ IP (—Ç.–µ. `socks5h://vpn:1080` ‚Äî –Ω–µ –∑–∞—Ä–∞–±–æ—Ç–∞–µ—Ç).
* –ù–∞–ª–∏—á–∏–µ —Å–µ—Ç–∏ **–Ω–µ —Å–æ–∑–¥–∞—ë—Ç VPN-–∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å tun0** –∏ –Ω–µ –Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç —Ç—Ä–∞—Ñ–∏–∫ –≤ VPN –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî tun0 –∂–∏–≤—ë—Ç –≤–Ω—É—Ç—Ä–∏ vpn-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –ü–æ–∫–∞ vpn –Ω–µ –∑–∞–ø—É—â–µ–Ω, ¬´vpn-—Å–µ—Ç—å¬ª ‚Äî —ç—Ç–æ –ø—Ä–æ—Å—Ç–æ —Å–µ—Ç—å Docker –∏ —Ç—Ä–∞—Ñ–∏–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ —É—Ö–æ–¥–∏—Ç –Ω–∞—Ä—É–∂—É –ø–æ –æ–±—ã—á–Ω–æ–º—É NAT —Ö–æ—Å—Ç–∞.

---

## –î–µ—Ç–∞–ª–∏: –∫–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –ø–æ—á–µ–º—É

1. **Docker network vs VPN –≤–Ω—É—Ç—Ä–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞**

   * Docker network ‚Äî —ç—Ç–æ –ª–æ–≥–∏—á–µ—Å–∫–∏–π –º–æ—Å—Ç (bridge) —É–ø—Ä–∞–≤–ª—è–µ–º—ã–π Docker daemon. –û–Ω–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ –æ—Ç —Ç–æ–≥–æ, –µ—Å—Ç—å –ª–∏ –≤–Ω—É—Ç—Ä–∏ –Ω–µ—ë –∫–∞–∫–∏–µ-—Ç–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ã.
   * VPN (tun0) ‚Äî —ç—Ç–æ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å, –ø–æ–¥–Ω—è—Ç—ã–π *–≤–Ω—É—Ç—Ä–∏* vpn-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞. –û–Ω –Ω–µ ¬´–≤–ø–∏–ª–∏–≤–∞–µ—Ç—Å—è¬ª –≤ Docker network. –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø—Ä–æ–∫—Å–∏ –≤–Ω—É—Ç—Ä–∏ vpn-–∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ (dante/tinyproxy) —Å–ª—É—à–∞–µ—Ç –Ω–∞ IP –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ –≤ Docker network –∏ –¥–µ–ª–∞–µ—Ç egress —á–µ—Ä–µ–∑ tun0.

2. **–ö–æ–≥–¥–∞ app –∑–∞–ø—É—Å–∫–∞–µ—Ç—Å—è –∏ —Å–µ—Ç—å –µ—Å—Ç—å, –Ω–æ vpn –Ω–µ –∑–∞–ø—É—â–µ–Ω**

   * App –ø–æ–¥–∫–ª—é—á–∞–µ—Ç—Å—è –∫ —Å–µ—Ç–∏ `vpn-net` ‚Üí —ç—Ç–æ —É–¥–∞—á–Ω–æ.
   * `docker` DNS –≤—ã–¥–∞—ë—Ç –∏–º–µ–Ω–∞ —Ç–æ–ª—å–∫–æ –¥–ª—è **—Ä–∞–±–æ—Ç–∞—é—â–∏—Ö** –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–æ–≤ –Ω–∞ —ç—Ç–æ–π —Å–µ—Ç–∏. –ï—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `vpn` –Ω–µ—Ç ‚Äî –∏–º—è `vpn` –Ω–µ —Ä–µ–∑–æ–ª–≤–∏—Ç—Å—è.
   * –ï—Å–ª–∏ –≤ –∫–æ–Ω—Ñ–∏–≥–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –∂—ë—Å—Ç–∫–æ —É–∫–∞–∑–∞–Ω `socks5h://vpn:1080`, –ø–æ–ø—ã—Ç–∫–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –±—É–¥—É—Ç –ø–∞–¥–∞—Ç—å (Connection refused / name not found). –û–Ω–∏ –Ω–µ –ø–µ—Ä–µ–∫–ª—é—á–∞—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –Ω–∞ ¬´–æ–±—ã—á–Ω—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç¬ª, –µ—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–µ —É–º–µ–µ—Ç fallback.
   * –ï—Å–ª–∏ –∂–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ **–Ω–µ —á–µ—Ä–µ–∑ proxy**, –∞ –Ω–∞–ø—Ä—è–º—É—é, –µ–≥–æ egress –ø–æ–π–¥—ë—Ç —á–µ—Ä–µ–∑ Docker NAT –Ω–∞ —Ö–æ—Å—Ç –∏ –¥–∞–ª–µ–µ –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç (–æ–±—ã—á–Ω—ã–π —Ö–æ—Å—Ç–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–Ω–µ—Ç).

3. **–ï—Å–ª–∏ vpn –∑–∞–ø—É—â–µ–Ω –ø–æ—Å–ª–µ —Ç–æ–≥–æ, –∫–∞–∫ –∑–∞–ø—É—Å—Ç–∏–ª–∏—Å—å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è**

   * –ü–æ—Å–ª–µ –∑–∞–ø—É—Å–∫–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `vpn` ‚Äî –æ–Ω –±—É–¥–µ—Ç –ø—Ä–∏—Å–æ–µ–¥–∏–Ω—ë–Ω –∫ `vpn-net`, –ø–æ–ª—É—á–∏—Ç IP, Docker DNS –Ω–∞—á–Ω—ë—Ç —Ä–µ–∑–æ–ª–≤–∏—Ç—å `vpn` ‚Üí —Ç–æ–≥–¥–∞ `socks5h://vpn:1080` —Å—Ç–∞–Ω–µ—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —Å–º–æ–≥—É—Ç —É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ (–µ—Å–ª–∏ –æ–Ω–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ –¥–µ–ª–∞—é—Ç –ø–æ–ø—ã—Ç–∫–∏). –ù–µ–∫–æ—Ç–æ—Ä—ã–µ –∫–ª–∏–µ–Ω—Ç—ã –æ—Ç–∫—Ä—ã–≤–∞—é—Ç –æ–¥–Ω–æ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ –∏ –Ω–µ –ø–µ—Ä–µ—Å–æ–∑–¥–∞—é—Ç –µ–≥–æ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ ‚Äî –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –Ω—É–∂–µ–Ω restart –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è –∏–ª–∏ –ª–æ–≥–∏–∫–∞ reconnection.

---

## –ß—Ç–æ —Ä–µ–∫–æ–º–µ–Ω–¥—É—é —Å–¥–µ–ª–∞—Ç—å (–ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã)

### 1) –°–æ–∑–¥–∞—ë–º —Å–µ—Ç—å –∑–∞—Ä–∞–Ω–µ–µ (bootstrap)

–°–æ–∑–¥–∞–π—Ç–µ `vpn-net` –æ–¥–∏–Ω —Ä–∞–∑ –≤—Ä—É—á–Ω—É—é (–∏–ª–∏ —Å–∫—Ä–∏–ø—Ç–æ–º) ‚Äî —Ç–æ–≥–¥–∞ –ª—é–±–æ–π compose, –æ–±—ä—è–≤–∏–≤—à–∏–π `external: true`, –Ω–µ —É–ø–∞–¥—ë—Ç.

```bash
docker network inspect vpn-net >/dev/null 2>&1 || \
  docker network create vpn-net
```

–í `docker-compose.yml` –≤—Å–µ—Ö app/services –∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ:

```yaml
networks:
  vpn-net:
    external: true
```

–ü–ª—é—Å: –ø–æ–º–µ—Å—Ç–∏—Ç–µ —ç—Ç–æ—Ç `docker network create` –≤ `Makefile`/—Å–∫—Ä–∏–ø—Ç –¥–µ–ø–ª–æ—è, —á—Ç–æ–±—ã –∫–æ–º–∞–Ω–¥–∞ –±—ã–ª–∞ –∏–¥–µ–º–ø–æ—Ç–µ–Ω—Ç–Ω–æ–π.

---

### 2) –ü–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞ (—Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è)

–õ—É—á—à–µ –∑–∞–ø—É—Å–∫–∞—Ç—å –≤ —Ç–∞–∫–æ–º –ø–æ—Ä—è–¥–∫–µ:

1. `vpn` (–ø–æ–¥–Ω–∏–º–∞–µ—Ç proxy –∏ tun0)
2. `dev` / `apps`

–ï—Å–ª–∏ –Ω—É–∂–µ–Ω —Ä—É—á–Ω–æ–π –∑–∞–ø—É—Å–∫ –æ—Ç–¥–µ–ª—å–Ω–æ ‚Äî —ç—Ç–æ –Ω–æ—Ä–º–∞–ª—å–Ω–æ, –Ω–æ –ø–æ—Ä—è–¥–æ–∫ –≥–∞—Ä–∞–Ω—Ç–∏—Ä—É–µ—Ç, —á—Ç–æ `vpn` —É–∂–µ –¥–æ—Å—Ç—É–ø–µ–Ω.

---

### 3) –û–±—Ä–∞–±–∞—Ç—ã–≤–∞—Ç—å –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–µ proxy –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è—Ö

–ï—Å–ª–∏ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –∫—Ä–∏—Ç–∏—á–Ω–æ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç proxy, –¥–∞–π—Ç–µ –µ–º—É –ø–æ–≤–µ–¥–µ–Ω–∏–µ fallback:

* –≤–∞—Ä–∏–∞–Ω—Ç A: **–∂–¥–∞—Ç—å proxy** (healthcheck/loop) ‚Äî –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç—Å—è –¥–æ –ø–æ—è–≤–ª–µ–Ω–∏—è `vpn:1080`;
* –≤–∞—Ä–∏–∞–Ω—Ç B: **fallback –Ω–∞ –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø** (–µ—Å–ª–∏ –¥–æ–ø—É—Å—Ç–∏–º–æ —Å —Ç–æ—á–∫–∏ –∑—Ä–µ–Ω–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏);
* –≤–∞—Ä–∏–∞–Ω—Ç C: **–∑–∞–ø—É—Å–∫–∞—Ç—å —Å restart-policy –∏ healthcheck** ‚Äî –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–∞–º –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—Å—è, –µ—Å–ª–∏ –Ω–µ –º–æ–∂–µ—Ç –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è.

---

### 4) –û–ø—Ü–∏—è ¬´stub proxy¬ª (–µ—Å–ª–∏ –Ω–∞–¥–æ, –Ω–æ —Å –æ–≥–æ–≤–æ—Ä–∫–∞–º–∏)

–ú–æ–∂–Ω–æ –¥–µ—Ä–∂–∞—Ç—å –ª—ë–≥–∫–∏–π stub-proxy (small sidecar) –≤—Å–µ–≥–¥–∞ –∑–∞–ø—É—â–µ–Ω–Ω—ã–º, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏–Ω–∏–º–∞–µ—Ç connections –Ω–∞ `vpn:1080` –∏:

* –ª–∏–±–æ –æ—Ç–≤–µ—Ç–∏—Ç –æ—à–∏–±–∫–æ–π / 502, –ø–æ–∫–∞ —Ä–µ–∞–ª—å–Ω—ã–π proxy –Ω–µ –ø–æ—è–≤–∏–ª—Å—è,
* –ª–∏–±–æ –ø—Ä–æ–±—Ä–æ—Å–∏—Ç —Ç—Ä–∞—Ñ–∏–∫ –Ω–∞–ø—Ä—è–º—É—é –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç (–µ—Å–ª–∏ –≤—ã —Ö–æ—Ç–∏—Ç–µ ¬´–º—è–≥–∫–∏–π¬ª fallback).

–ú–∏–Ω—É—Å—ã: —Ç–∞–∫–æ–π stub –º–æ–∂–µ—Ç –ø–æ –æ—à–∏–±–∫–µ –¥–∞—Ç—å egress –≤–Ω–µ VPN ‚Üí –Ω–∞–¥–æ –≤–Ω–∏–º–∞—Ç–µ–ª—å–Ω–æ –ø—Ä–æ–¥—É–º–∞—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å.

---

### 5) dev —Å `network_mode: "container:vpn"`

–î–ª—è dev: –µ—Å–ª–∏ –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ `network_mode: "container:vpn"`, —Ç–æ dev –±—É–¥–µ—Ç —Ä–∞–±–æ—Ç–∞—Ç—å **—Ç–æ–ª—å–∫–æ** –µ—Å–ª–∏ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å —Ç–æ—á–Ω—ã–º –∏–º–µ–Ω–µ–º `vpn` –∑–∞–ø—É—â–µ–Ω. –≠—Ç–æ —Ö–æ—Ä–æ—à–∏–π —Å–ø–æ—Å–æ–± –≥–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å, —á—Ç–æ dev –≤—Å–µ–≥–¥–∞ –∏–º–µ–µ—Ç —Ç–µ –∂–µ –º–∞—Ä—à—Ä—É—Ç—ã/DNS, —á—Ç–æ vpn. –ù–æ –æ–±—Ä–∞—Ç–Ω—ã–π —ç—Ñ—Ñ–µ–∫—Ç: –≤—ã –Ω–µ —Å–º–æ–∂–µ—Ç–µ –ø–æ–¥–Ω—è—Ç—å dev –µ—Å–ª–∏ vpn –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω.

---

## –ü—Ä–∏–º–µ—Ä –ø—Ä–∞–∫—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞ –¥–µ–ø–ª–æ—è

1. Bootstrap (–æ–¥–∏–Ω —Ä–∞–∑):

```bash
./scripts/bootstrap.sh   # —Å–æ–¥–µ—Ä–∂–∏—Ç docker network create vpn-net
```

2. –ü–æ–¥–Ω—è—Ç—å vpn:

```bash
cd infra/vpn
docker compose up -d
```

3. –ü–æ–¥–Ω—è—Ç—å apps / dev:

```bash
cd services/app
docker compose up -d

cd services/dev
docker compose up -d   # dev –∏—Å–ø–æ–ª—å–∑—É–µ—Ç network_mode: container:vpn -> vpn –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –∑–∞–ø—É—â–µ–Ω
```

4. –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å dev –Ω–µ —Ç—Ä–æ–≥–∞—è vpn:

```bash
cd services/dev
docker compose down
# vpn –æ—Å—Ç–∞—ë—Ç—Å—è –∑–∞–ø—É—â–µ–Ω
```

---

## –ö–æ—Ä–æ—Ç–∫–∏–π —á–µ–∫–ª–∏—Å—Ç (—á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø—Ä–æ–±–ª–µ–º)

* [ ] –°–æ–∑–¥–∞—Ç—å —Å–µ—Ç—å `vpn-net` –∑–∞—Ä–∞–Ω–µ–µ (—Å–∫—Ä–∏–ø—Ç/Makefile).
* [ ] –í `compose` –≤—Å–µ—Ö apps —É–∫–∞–∑–∞—Ç—å `external: true` –¥–ª—è `vpn-net`.
* [ ] –†–µ—à–∏—Ç—å –ø–æ–≤–µ–¥–µ–Ω–∏–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–π –ø—Ä–∏ –æ—Ç—Å—É—Ç—Å—Ç–≤–∏–∏ proxy (–∂–¥–∞—Ç—å/—Ñ–µ–π–ª–∏—Ç—å/—Ñ–æ–ª–±—ç–∫).
* [ ] –†–µ—à–∏—Ç—å –ø–æ—Ä—è–¥–æ–∫ –∑–∞–ø—É—Å–∫–∞: –ø—Ä–µ–¥–ø–æ—á—Ç–∏—Ç–µ–ª—å–Ω–æ —Å–Ω–∞—á–∞–ª–∞ `vpn`, –ø–æ—Ç–æ–º `dev/apps`.
* [ ] –ù–µ –∑–∞–±—ã—Ç—å –ø—Ä–æ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å: –µ—Å–ª–∏ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è fallback –Ω–∞ –ø—Ä—è–º–æ–π –¥–æ—Å—Ç—É–ø ‚Äî –ø–æ–Ω–∏–º–∞—Ç—å —Ä–∏—Å–∫–∏ —É—Ç–µ—á–∫–∏ credentials/LLM-–∑–∞–ø—Ä–æ—Å–æ–≤.

