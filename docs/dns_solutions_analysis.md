# Анализ решений для проблемы DNS в Podman контейнере с AdGuard VPN

## Уникальные решения (без повторов)

### 1. cloudflared (DoH proxy) - РЕКОМЕНДУЕТСЯ GPT5
**Описание:** Утилита от Cloudflare, которая слушает локально UDP/TCP на 127.0.0.1:53 и пересылает запросы через DoH (HTTPS).

**Команда запуска:**
```bash
sudo podman run -d --name cloudflared \
  --network=ns:/run/netns/vpn-ns \
  docker.io/cloudflare/cloudflared:latest \
  proxy-dns --address 127.0.0.1 --port 53 \
    --upstream https://1.1.1.1/dns-query \
    --upstream https://1.0.0.1/dns-query
```

**Использование контейнера:**
```bash
sudo podman run -it --rm \
  --network=ns:/run/netns/vpn-ns \
  --dns 127.0.0.1 \
  docker.io/alpine:latest sh
```

**Плюсы:**
- ✅ Простая реализация, проверенная во многих сценариях
- ✅ Использует DoH (HTTPS) - точно проходит через TCP/HTTPS через VPN
- ✅ Не требует изменения AdGuard VPN CLI
- ✅ Принимает обычные UDP запросы от приложений
- ✅ Рекомендуется GPT5 как лучшее решение

**Минусы:**
- ❌ Нужен дополнительный контейнер/процесс (sidecar pattern)
- ❌ Использует DoH (HTTPS) - может быть медленнее, чем чистый TCP

---

### 2. unbound (рекурсивный DNS-резолвер) - РЕКОМЕНДУЕТСЯ GPT5
**Описание:** Легковесный, но мощный рекурсивный DNS-сервер. Умеет принудительно отправлять запросы вышестоящему серверу только по TCP.

**Команда запуска:**
```bash
# В контейнере
apk add unbound

# Конфигурация /etc/unbound/unbound.conf
server:
    interface: 127.0.0.1
    access-control: 127.0.0.0/8 allow
    do-udp: yes
    do-tcp: yes
    tcp-upstream: yes  # Ключевой параметр!

forward-zone:
    name: "."
    forward-addr: 8.8.8.8@53  # Google DNS

# Запуск
unbound -d
```

**Плюсы:**
- ✅ Более гибкая настройка (DoT, кеш, DNSSEC и пр.)
- ✅ Рекомендуется GPT5 как профессиональное решение
- ✅ Поддерживает кэширование DNS запросов
- ✅ Поддерживает DNSSEC
- ✅ Лёгкий и подходит для Podman

**Минусы:**
- ❌ Нужна конфигурация (чуть больше работы, чем cloudflared)
- ❌ Нужен дополнительный контейнер/процесс

---

### 3. dnscrypt-proxy - РЕКОМЕНДУЕТСЯ GPT5 и Perplexity
**Описание:** Гибкий прокси, поддерживающий DoH/DoT/DNSCrypt. Принимает UDP/TCP локально и форвардит upstream по DoH/DoT/TCP.

**Конфигурация:**
```toml
force_tcp = true
listen_addresses = ['127.0.0.1:53']
upstream_servers = ['8.8.8.8:53']  # Или DoH сервер
```

**Плюсы:**
- ✅ Рекомендуется GPT5 и Perplexity как гибкое решение
- ✅ Поддерживает множественные протоколы (DoH, DoT, DNSCrypt)
- ✅ Принимает обычные UDP запросы от приложений

**Минусы:**
- ❌ Нужна конфигурация (особенно для dnscrypt-proxy)
- ❌ Нужен дополнительный контейнер/процесс

---

### 4. dns2tcp - РЕКОМЕНДУЕТСЯ Perplexity
**Описание:** Легковесный конвертер UDP→TCP. Слушает на UDP (например, порт 5353), forwards queries as TCP to 8.8.8.8:53.

**Установка и запуск:**
```bash
# В Alpine
apk add build-base git make
git clone https://github.com/zfl9/dns2tcp && cd dns2tcp && make && cp dns2tcp /usr/local/bin/

# Запуск
dns2tcp -L 127.0.0.1#5353 -R 8.8.8.8#53

# Использование с Podman
podman run ... --dns 127.0.0.1:5353 ...
```

**Плюсы:**
- ✅ Рекомендуется Perplexity как легковесное решение
- ✅ Легковесный
- ✅ Простая установка

**Минусы:**
- ❌ Использует нестандартный порт (5353)
- ❌ Нужна компиляция из исходников
- ❌ Нужен дополнительный контейнер/процесс

---

### 5. stubby (DoT stub) - УПОМЯНАТ GPT5
**Описание:** Минималистичный локальный stub resolver для DoT.

**Установка и запуск:**
```bash
# В Alpine
apk add stubby

# Конфигурация /etc/stubby/stubby.yml
upstream:
  - tls://8.8.8.8@853  # DoT на Google DNS

# Запуск
stubby

# Настройка resolv.conf
nameserver 127.0.0.1
```

**Плюсы:**
- ✅ Минималистичный
- ✅ Использует DoT (TLS) - безопаснее, чем plain TCP
- ✅ Упоминается GPT5

**Минусы:**
- ❌ Только DoT, не поддерживает DoH
- ❌ Нужна конфигурация
- ❌ Нужен дополнительный контейнер/процесс

---

### 6. utdns - УПОМЯНАТ Grok
**Описание:** Специализированный инструмент для проксирования UDP DNS в TCP DNS. Простой прокси, который перехватывает UDP запросы и отправляет их по TCP, правильно обрабатывая протокол.

**Установка и запуск:**
```bash
# В контейнере на базе Alpine
apk add gcc make
git clone https://github.com/rahra/utdns
make
./utdns

# Запуск
utdns -l 127.0.0.1:53 -r 8.8.8.8:53

# Настройка resolv.conf
nameserver 127.0.0.1
```

**Плюсы:**
- ✅ Специализированный для UDP→TCP
- ✅ Правильно обрабатывает протокол (включая префикс длины для TCP DNS)
- ✅ Упоминается Grok

**Минусы:**
- ❌ Нужна компиляция из исходников
- ❌ Нужен дополнительный контейнер/процесс
- ❌ Менее проверенный, чем cloudflared/unbound

---

### 7. dnsmasq - УПОМЯНАТ Perplexity
**Описание:** Лёгкий, принимает UDP/TCP, но upstream по умолчанию UDP.

**Установка и запуск:**
```bash
# В Alpine
apk add dnsmasq

# Запуск с TCP upstream
dnsmasq --server=8.8.8.8#53 --listen-address=127.0.0.1
```

**Плюсы:**
- ✅ Лёгкий
- ✅ Упоминается Perplexity

**Минусы:**
- ❌ Upstream по умолчанию UDP (не решает проблему)
- ❌ Нужно использовать в комбинации с unbound для TCP upstream

---

### 8. GOST DNS Proxy - УПОМЯНАТ Perplexity
**Описание:** Поддерживает множественные протоколы (UDP to TCP/DoT/DoH).

**Установка и запуск:**
```bash
# В Alpine
apk add go
# Скомпилировать из repo
gost -L dns://:53 -F dns://8.8.8.8:53/tcp
```

**Плюсы:**
- ✅ Поддерживает множественные протоколы
- ✅ Упоминается Perplexity

**Минусы:**
- ❌ Нужна компиляция из исходников
- ❌ Нужен дополнительный контейнер/процесс
- ❌ Менее проверенный

---

### 9. socat (НЕ РЕКОМЕНДУЕТСЯ GPT5 и Grok)
**Описание:** Быстрый "костыль" для теста. Просто перенаправляет поток данных.

**Команда внутри контейнера:**
```bash
socat UDP4-LISTEN:53,fork,reuseaddr TCP4:8.8.8.8:53
```

**Плюсы:**
- ✅ Быстрый "костыль" для теста
- ✅ Простая установка

**Минусы:**
- ❌ НЕ РЕКОМЕНДУЕТСЯ GPT5 и Grok
- ❌ DNS over TCP требует спецификации (framing, length-prefix) - простая пересылка UDP payload на TCP-сокет часто ломается
- ❌ Менее надёжное, чем специализированные resolver-прокси
- ❌ Не правильно обрабатывает протокол

---

### 10. Настройка AdGuard VPN CLI (МЕНЕЕ УНИВЕРСАЛЬНО)
**Описание:** Попытаться настроить AdGuard VPN CLI на поддержку UDP DNS.

**Анализ:**
- ❌ Вероятно нет (или ограниченно) - документация и багрепорты показывают, что AdGuard VPN CLI/режимы ориентированы на TCP/HTTP(S) DNS (DoH/DoT) и SOCKS/TCP
- ❌ Прямой прозрачный UDP→TCP проксинг не всегда возможен
- ❌ Менее универсально, чем локальный stub

**Плюсы:**
- ✅ Не нужен дополнительный контейнер/процесс

**Минусы:**
- ❌ МЕНЕЕ УНИВЕРСАЛЬНО
- ❌ Вероятно невозможно
- ❌ Зависит от версии AdGuard CLI

---

## Сводная таблица решений

| Решение | Рекомендация | Сложность | Проверенность | Протокол upstream | Дополнительный контейнер |
|----------|---------------|-------------|----------------|-------------------|------------------------|
| cloudflared | ✅ GPT5 | Низкая | Высокая | DoH (HTTPS) | Да |
| unbound | ✅ GPT5 | Средняя | Высокая | TCP | Да |
| dnscrypt-proxy | ✅ GPT5, Perplexity | Средняя | Высокая | DoH/DoT/DNSCrypt | Да |
| dns2tcp | ✅ Perplexity | Высокая | Средняя | TCP | Да |
| stubby | Упомянут GPT5 | Низкая | Средняя | DoT (TLS) | Да |
| utdns | Упомянут Grok | Высокая | Низкая | TCP | Да |
| dnsmasq | Упомянут Perplexity | Низкая | Высокая | UDP (по умолчанию) | Да |
| GOST DNS Proxy | Упомянут Perplexity | Высокая | Низкая | UDP/TCP/DoT/DoH | Да |
| socat | ❌ GPT5, Grok | Низкая | Высокая | TCP | Да |
| AdGuard CLI config | ❌ Менее универсально | Низкая | - | - | Нет |

## Рекомендации

### Для быстрого решения:
Используйте **cloudflared** - самый простой и проверенный вариант.

### Для профессионального решения:
Используйте **unbound** или **dnscrypt-proxy** - более гибкие решения с кэшированием и поддержкой DNSSEC.

### Для минимального решения:
Используйте **stubby** - минималистичный DoT stub resolver.

### НЕ РЕКОМЕНДУЕТСЯ:
- **socat** - не правильно обрабатывает протокол DNS over TCP
- **Настройка AdGuard CLI** - вероятно невозможно, менее универсально

## Следующие шаги

1. Выбрать одно из рекомендуемых решений (cloudflared, unbound, dnscrypt-proxy)
2. Изучить документацию по выбранному решению в Context7
3. Протестировать выбранное решение
4. Обновить документацию `vpn-utils/docs/vs_code_podman.md` с рабочим решением
