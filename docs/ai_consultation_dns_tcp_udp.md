# Консультация по проблеме DNS в Podman контейнере с AdGuard VPN

## Текущая ситуация

Мы пытаемся запустить Podman контейнер в VPN namespace (`vpn-ns`) с AdGuard VPN CLI.

### Что работает ✅
1. **Контейнер успешно запускается в VPN namespace** - использует параметр `--network=ns:/run/netns/vpn-ns`
2. **Network namespace правильный** - контейнер использует тот же network namespace, что и VPN процесс (`net:[4026533317]`)
3. **VPN интерфейс доступен** - контейнер видит интерфейс `tun0` с IP `172.16.219.2/32`
4. **Маршрутизация правильная** - маршрут по умолчанию идет через `tun0`
5. **TCP соединения работают** - контейнер может подключаться к внешним серверам по TCP (например, DNS сервер 8.8.8.8:53)
6. **DoH (DNS-over-HTTPS) работает** - DNS запросы через HTTPS успешно выполняются через VPN

### Что НЕ работает ❌
1. **UDP DNS запросы не работают** - обычные DNS запросы по UDP (порт 53) таймаутят
2. **Причина** - AdGuard VPN CLI работает только с TCP для DNS, не поддерживает UDP DNS

## Что мы ищем

### 1. Утилита для преобразования UDP DNS в TCP DNS

**Проблема:** Приложения в контейнере используют стандартные UDP DNS запросы, которые не проходят через AdGuard VPN CLI.

**Что нужно:** Утилита, которая будет:
- Перехватывать UDP DNS запросы от приложений
- Преобразовывать их в TCP DNS запросы
- Отправлять TCP запросы через VPN
- Возвращать ответы приложениям

**Вопросы:**
- Существует ли такая утилита для Linux?
- Как она называется?
- Как её настроить в контейнере?
- Нужно ли её устанавливать на хосте или в контейнере?

### 2. Альтернативные решения

**Вариант 1:** Использование DNS-over-TLS (DoT) или DNS-over-HTTPS (DoH)
- Можно ли настроить приложения в контейнере на использование DoT/DoH вместо обычного DNS?
- Поддерживает ли Podman настройку DoT/DoH через параметр `--dns`?
- Как настроить code-server на использование DoT/DoH?

**Вариант 2:** Использование локального DNS прокси
- Можно ли запустить локальный DNS прокси в контейнере, который будет конвертировать UDP в TCP?
- Какие существуют DNS прокси для Linux?
- Как их интегрировать с Podman контейнером?

**Вариант 3:** Изменение конфигурации AdGuard VPN CLI
- Можно ли настроить AdGuard VPN CLI на поддержку UDP DNS?
- Есть ли другие параметры конфигурации, которые мы упустили?

### 3. Технические детали

**Система:**
- OS: Linux 5.15
- Podman: версия 3.4.4
- AdGuard VPN CLI: версия неизвестна
- Cgroups: cgroup2

**VPN конфигурация:**
- Namespace: `vpn-ns`
- VPN интерфейс: `tun0` с IP `172.16.219.2/32`
- DNS upstream: 8.8.8.8
- Change system DNS: on

**Контейнер:**
- Команда запуска:
  ```bash
  sudo podman run -d \
    --name test-vpn \
    --network=ns:/run/netns/vpn-ns \
    --dns 8.8.8.8 \
    docker.io/alpine:latest \
    sleep infinity
  ```
- Network namespace: `net:[4026533317]` (правильный)
- DNS в `/etc/resolv.conf`: `nameserver 8.8.8.8`

**Тесты:**
- ✅ `ping 172.16.219.2` - работает
- ✅ `nc -zv 8.8.8.8 53` - работает (TCP)
- ✅ `wget https://dns.google/resolve?name=ifconfig.me&type=A` - работает (DoH)
- ❌ `nslookup ifconfig.me 8.8.8.8` - таймаут (UDP)
- ❌ `wget http://ifconfig.me` - не работает (DNS resolution)

## Пожалуйста, помогите с решением

Нам нужно найти способ, чтобы приложения в контейнере могли использовать DNS через AdGuard VPN CLI. Любые идеи, предложения или альтернативные решения приветствуются!
